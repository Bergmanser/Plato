<!DOCTYPE html>
<html>
  <head>
    <title>Upload een Quiz</title>
    <script src="https://cdn.ckeditor.com/ckeditor5/24.0.0/classic/ckeditor.js"></script>
    <link rel="stylesheet" href="./assets/css/quiz_creation_interface.css"/>
  </head>
  <body>
    <h1>Create a Quiz</h1>
    
    <form id="quiz-form">
    <label for="title">Quiz tiltle</label>
      <input type="text" id="title" name="title" placeholder="Title" required />
      <div>
        <label for="group-id-subject">Group ID/Subject:</label>
        <select id="group-id-subject">
          <option value="3000">3000</option>
          <option value="4000">4000</option>
          <option value="5000">5000</option>
          <option value="6000">6000</option>
          <option value="7000">7000</option>
          <option selected value="8000">8000</option>
        </select>
      </div>
      <label for="banner">Voeg een afbeelding toe als quiz banner</label>
      <div></div>
      <input type="file" id="banner" accept="image/jpeg,image/png,image/jpg" />
      <div>
      <label>Voeg in deze sectie de text voor de quiz toe</label>
      <div id="quill-container"></div>
      </div>
      <label for="difficulty">Difficulty:</label>
      <div>
        <select id="difficulty" name="difficulty">
            <option value="">Select difficulty</option>
            <option value="easy">Easy</option>
            <option value="average">Average</option>
            <option value="hard">Hard</option>
        </select>
    
        <div id="questions">
            <!-- <div id="question-0" class="question">
              <h2>Question 1</h2>
              <div>
                <input type="hidden" name="questions[0][id]" value="0">
                <label for="question-0-title">Question:</label>
                <input type="text" id="question-0-title" name="questions[0][title]" placeholder="Question" required>
    
                <p>Question type:</p>
                <select id="question-0-type" name="questions[0][type]" required>
                  <option value="">Select question type</option>
                  <option value="single-choice">Single choice</option>
                  <option value="multiple-choice">Multiple choice</option>
                </select>
    
                <div id="question-0-options" class="question-options d-flex my-4"></div>
    
                <button type="button" id="add-option-button-0">Add option</button>
    
                <div class="correct-answer-container">
                  <p>Correct option:</p>
                  <input type="hidden" id="question-0-correct-answer-input" name="questions[0][correct_answer]" />
                  <div id="question-0-correct-answer-display" class="correct-answer"></div>
                </div>
    
                <button type="button" id="select-correct-option-button-0">Select correct option</button>
    
                <button type="button" id="remove-question-button-0">Remove question</button>
              </div> -->
              <button id="add-option-button-">Add Option</button>
            </div>
          </div>
    
          <button type="button" id="add-question-button">Add question</button>
    
          <div class="mt-4 d-flex">
            <div class="mr-auto">
              <input type="text" id="remove-question-id-input" placeholder="Enter question ID">
              <button id="remove-question-button">Remove question</button>
            </div>
    
            <button type="submit">Submit quiz</button>
          </div>
    
        </form>
    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCHFj9oABXSxiWm7u1yPOvyhXQw_FRp5Lw",
    authDomain: "project-plato-eb365.firebaseapp.com",
    databaseURL: "https://project-plato-eb365-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-plato-eb365",
    storageBucket: "project-plato-eb365.appspot.com",
    messagingSenderId: "753582080609",
    appId: "1:753582080609:web:98b2db93e63a500a56e020",
    measurementId: "G-KHJXGLJM4Y"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth();
const db = getFirestore(app);

const quizForm = document.getElementById('quiz-form');
const questionsContainer = document.getElementById('questions');

// This code is responsible for dynamically adding new questions input fields
let questionId = 1;



// This code is responsible for handling the image upload related to the banner image
// const banner = document.getElementById('banner');
// banner.addEventListener('change', (event) => {
//     const file = event.target.files[0];
//     if (file) {
//         const reader = new FileReader();
//         reader.onload = (e) => {
//             const img = document.createElement('img');
//             img.src = e.target.result;
//             document.getElementById('banner-preview').appendChild(img);
//         };
//         reader.readAsDataURL(file);
//     } else {
//         const img = document.createElement('img');
//         img.src = 'MeerDanBijles-Logo.png';
//         document.getElementById('banner-preview').appendChild(img);
//     }
// });

// //Responsible for generating a GroupID for the quiz based on the selected group
// const groupIdSubject = document.getElementById('group-id-subject').value;
// const groupRef = doc(collection(db, 'quizzes'), groupIdSubject);
// getDoc(groupRef).then((doc) => {
//   if (doc.exists) {
//     // Generate the next group ID based on the current number of quizzes
//     const nextGroupId = parseInt(groupIdSubject) + doc.data().nextQuizId;
//     // Update the nextQuizId for the group
//     setDoc(groupRef, { nextQuizId: nextGroupId }, { merge: true });
//     // Set the group ID for the new quiz
//     quizForm.groupIdSubject.value = nextGroupId;
//   } else {
//     setDoc(groupRef, { nextQuizId: 1 });
//     quizForm.groupIdSubject.value = groupIdSubject;
//   }
// });

function initializeQuestion(questionId) {
  const addOptionButton = document.getElementById(`add-option-button-${questionId}`);
  const selectCorrectOptionButton = document.getElementById(`select-correct-option-button-${questionId}`);
  const correctOptionSelect = document.getElementById(`question-correct-option-select-${questionId}`);

  if (addOptionButton) {
    addOptionButton.addEventListener('click', () => {
      addOption(questionId);
      addOptionRemoveButton(questionId);
    });
  }

  if (selectCorrectOptionButton) {
    selectCorrectOptionButton.addEventListener('click', () => {
      selectCorrectOption(questionId, correctOptionSelect);
    });
  }

  removeQuestion(questionId);
};

// Add a question
function addQuestion() {
  const question = document.createElement('div');
  question.id = `question-${questionId}`;
  question.innerHTML = `
    <h2>Question ${questionId}</h2>
    <label for="question-title-${questionId}">Question title</label>
    <input type="text" id="question-title-${questionId}" placeholder="Question text" required />
    <select id="question-type-${questionId}" required>
      <option value="multiple-choice">Multiple Choice</option>
      <option value="true-or-false">True or False</option>
    </select>
    <div id="question-options-${questionId}"></div>
    <select id="question-correct-option-select-${questionId}" required></select>
    <input type="text" id="question-hint-${questionId}" placeholder="Hint" required />
    <button type="button" id="add-option-button-${questionId}">Add Option</button>
    <button type="button" id="select-correct-option-button-${questionId}">Select correct option</button>
    <button type="button" id="remove-question-button-${questionId}">Remove Question</button>
  `;

  questionsContainer.appendChild(question);

  // Initialize the question
  initializeQuestion(questionId);

  questionId++;
}

// Add an option
function addOption(questionId) {
  const question = document.getElementById(`question-${questionId}`);
  const optionsContainer = document.getElementById(`question-options-${questionId}`);

  const option = document.createElement('div');
  option.className = 'option';
  option.innerHTML = `
    <input type="radio" name="question-options-${questionId}" class="question-option-input" value="${optionsContainer.children.length}" required>
    <label for="question-option-text-${questionId}-${optionsContainer.children.length}" class="question-option-text-label">
      <input type="text" id="question-option-text-${questionId}-${optionsContainer.children.length}" placeholder="Option text" required>
    </label>
    <input type="hidden" id="question-option-correct-${questionId}-${optionsContainer.children.length}" value="">
    <button type="button" class="remove-option-button">Remove Option</button>
  `;

  optionsContainer.appendChild(option);

  const removeOptionButton = option.querySelector('.remove-option-button');
  removeOptionButton.addEventListener('click', () => {
    removeOption(questionId, option);
  });

  const correctOptionSelect = question.querySelector(`select#question-correct-option-select-${questionId}`);
  const correctOptionIndex = Array.from(questionOptions).findIndex(option => option.value === `${optionsContainer.children.length}`);

  if (correctOptionIndex !== -1) {
    correctOptionSelect.selectedIndex = correctOptionIndex;
  }
}

// // Add a remove option button
// function addOptionRemoveButton(questionId) {
//   const removeOptionButton = document.createElement('button');
//   removeOptionButton.textContent = 'Remove Option';
//   removeOptionButton.addEventListener('click', () => {
//     removeOption(questionId);
//   });

//   const optionsContainer = document.getElementById(`question-options-${questionId}`);
//   optionsContainer.appendChild(removeOptionButton);
// };

// // Remove an option
// function removeOption(questionId) {
//   const question = document.getElementById(`question-${questionId}`);
//   const optionsContainer = document.getElementById(`question-options-${questionId}`);

//   if (optionsContainer.children.length > 1) {
//     optionsContainer.removeChild(optionsContainer.lastChild);
//   }
// };

// Remove an option
function removeOption(questionId, option) {
  const question = document.getElementById(`question-${questionId}`);
  const optionsContainer = document.getElementById(`question-options-${questionId}`);
  const correctOptionContainer = document.getElementById(`question-correct-option-container-${questionId}`);
  const correctOptionSelect = correctOptionContainer.querySelector(`select[id="question-correct-option-${questionId}"]`);

  if (optionsContainer.contains(option)) {
    optionsContainer.removeChild(option);

    const correctOptionIndex = Array.from(correctOptionSelect.options).findIndex(option => option.value === `${option.querySelector('input[type="radio"]').value}`);

    if (correctOptionIndex !== -1) {
      correctOptionSelect.selectedIndex = correctOptionIndex;
    }

    const lastOption = optionsContainer.lastChild;

    if (lastOption) {
      lastOption.querySelector('input[type="radio"]').value = optionsContainer.children.length;
    }
  }
};

// Select a correct option
function selectCorrectOption(questionId) {
  const correctOptionSelect = document.getElementById(`question-correct-option-select-${questionId}`);
  const questionOptions = document.getElementsByName(`question-options-${questionId}`);

  for (const option of questionOptions) {
    if (option.checked) {
      const correctOptionText = option.nextElementSibling;
      correctOptionSelect.value = option.value;
      correctOptionText.value = option.value;
      break;
    }
  }
}

// Remove a question
function removeQuestion(questionId) {
  const question = document.getElementById(`question-${questionId}`);
  if (question) {
    questionsContainer.removeChild(question);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  addQuestion();

  // Add an event listener to the "Add Question" button
  document.getElementById('add-question-button').addEventListener('click', () => {
    addQuestion();
  });

  // Add event listeners for the existing questions
  for (let i = 0; i < 2; i++) {
    initializeQuestion(i);
  }
});



// Check if the user is logged in
onAuthStateChanged(auth, (user) => {
  if (user) {
    console.log('Current User Email:', user.email);

    const quizForm = document.getElementById('quiz-form');

    // This addEventListener is responsible for uploading the quiz data to Firestore
    quizForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const title = document.getElementById('title');
      const groupId = document.getElementById('group-id-subject');
      const banner = document.getElementById('banner');
      const quillContainer = document.getElementById('quill-container');
      const difficulty = document.getElementById('difficulty');

      const titleError = document.getElementById(`title-error`);
      const groupIdError = document.getElementById(`group-id-error`);
      const bannerError = document.getElementById(`banner-error`);
      const quillError = document.getElementById(`quill-error`);
      const difficultyError = document.getElementById(`difficulty-error`);

      if (title.value.trim() === '') {
        titleError.innerText = 'Title is required';
      } else {
        titleError.innerText = '';
      }

      if (groupId.value === '') {
        groupIdError.innerText = 'Group ID is required';
      } else {
        groupIdError.innerText = '';
      }

      if (banner.files.length === 0) {
        bannerError.innerText = 'Banner is required';
      }

      if (quillContainer.innerHTML.trim() === '') {
        quillError.innerText = 'Embedded text is required';
      }

      if (difficulty.value.trim() === '') {
        difficultyError.innerText = 'Difficulty is required';
      }

      if (
        title.value.trim() !== '' &&
        groupId.value !== '' &&
        banner.files.length > 0 &&
        quillContainer.innerHTML.trim() !== '' &&
        difficulty.value.trim() !== ''
      ) {
        // Collect question data
        const questionsData = [];
        for (const questionId of questionsAndIds) {
          const correctOptionSelected = document.querySelector(`input[name="question-option-correct-${questionId}"]:checked`);
          if (!correctOptionSelected) {
            // Display an error message to the user
            document.getElementById(`select-correct-option-button-${questionId}`).setCustomValidity('Please select a correct option for this question');
            document.getElementById(`select-correct-option-button-${questionId}`).reportValidity();
            return;
          }

          const questionTitle = document.getElementById(`question-title-${questionId}`).value;
          const questionType = document.getElementById(`question-type-${questionId}`).value;
          const correctOptionText = document.getElementById(`question-correct-option-text-${questionId}`).value;
          const correctOptionIndex = Array.from(document.getElementsByName(`question-option-correct-${questionId}`)).findIndex(option => option.checked);

          const questionOptions = [];
          for (let i = 0; i < 3; i++) {
            const optionInput = document.getElementById(`question-option-text-${questionId}-${i}`);
            const isCorrect = i === correctOptionIndex;
            if (optionInput) {
              questionOptions.push({
                text: optionInput.value,
                isCorrect
              });
            }
          }

          questionsData.push({
            title: questionTitle,
            type: questionType,
            options: questionOptions,
            correctOption: {
              text: correctOptionText,
              index: correctOptionIndex
            }
          });
        };

        const creationDate = new Date();
        const modificationDate = new Date();

        // Update the modification date before saving the quiz to Firestore
        modificationDate.setSeconds(modificationDate.getSeconds() + 1);newQuiz.modificationDate = modificationDate;

        // Create a new quiz object
        const newQuiz = {
          title: title.value,
          groupId: groupId.value,
          banner: banner.files[0],
          quillContainer: quillContainer.innerHTML,
          difficulty: difficulty.value,
          questions: questionsData,
          creationDate,
          modificationDate
        };

        // Save the new quiz to Firestore
        saveQuizToFirestore(newQuiz);

      } else {
        alert('Please fill out all required fields.');
      }
    });

  } else {
    // Redirect the user to the 'login_parent_tvt.html' page if the user is not logged in
    window.location.href = "login_parent_tvt.html";
  }
});

async function saveQuizToFirestore(quiz) {
  // Get a reference to the Firestore collection
  const quizCollection = firebase.firestore().collection('quizzes');

  // Create a new quiz document in the Firestore collection
  const quizDocument = await quizCollection.add({
    title: quiz.title,
    description: quiz.description,
    questions: Object.values(quiz.questions).map(question => ({
      id: question.id,
      text: question.text,
      correctOption: question.correctOption,
      options: question.options.map(option => ({
        id: option.id,
        text: option.text,
      })),
    })),
  });

  // Return the Firestore document ID
  return quizDocument.id;
};

    </script>
    <!-- <script src="quiz_creation.js"></script> -->
    
    <!-- <script src="quill-image-uploader.js"></script> -->
    <!-- <script>
        import { Quill } from "quill";
        import { QuillImageUploader } from 'quill-image-uploader';

        const uploader = new QuillImageUploader({
        uploadEndpoint: '/upload-image',
        quill: quill,
});

    </script> -->
    <!-- <script type="text/javascript">
        Quill.register("modules/imageUploader", ImageUploader);
  
        console.log("script");
        document.addEventListener("DOMContentLoaded", function () {
          const fullToolbarOptions = [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic"],
            ["clean"],
            ["image"]
          ];
  
          console.log("Dom loaded");
  
          var quill = new Quill("#editor", {
            theme: "snow",
            modules: {
              toolbar: {
                container: fullToolbarOptions
              },
              imageUploader: {
                upload: (file) => {
                  return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append("image", file);
  
                    fetch(
                      "https://api.imgbb.com/1/upload?key=d36eb6591370ae7f9089d85875e56b22",
                      {
                        method: "POST",
                        body: formData
                      }
                    )
                      .then((response) => response.json())
                      .then((result) => {
                        console.log(result);
                        resolve(result.data.url);
                      })
                      .catch((error) => {
                        reject("Upload failed");
                        console.error("Error:", error);
                      });
                  });
                }
              }
            }
          });
  
          console.log(quill);
        });
      </script> -->


    <script>
      ClassicEditor.create(document.querySelector('#quill-container'), {
        // Add any desired options here
      })
      .catch(error => {
        console.error(error);
      });

    //   Quill.register("modules/imageUploader", ImageUploader);
  
    //     console.log("script");
    //     document.addEventListener("DOMContentLoaded", function () {
    //       const fullToolbarOptions = [
    //         [{ header: [1, 2, 3, false] }],
    //         ["bold", "italic"],
    //         ["clean"],
    //         ["image"]
    //       ];
  
    //       console.log("Dom loaded");
  
    //       var quill = new Quill("#editor", {
    //         theme: "snow",
    //         modules: {
    //           toolbar: {
    //             container: fullToolbarOptions
    //           },
    //           imageUploader: {
    //             upload: (file) => {
    //               return new Promise((resolve, reject) => {
    //                 const formData = new FormData();
    //                 formData.append("image", file);
  
    //                 fetch(
    //                   "https://api.imgbb.com/1/upload?key=d36eb6591370ae7f9089d85875e56b22",
    //                   {
    //                     method: "POST",
    //                     body: formData
    //                   }
    //                 )
    //                   .then((response) => response.json())
    //                   .then((result) => {
    //                     console.log(result);
    //                     resolve(result.data.url);
    //                   })
    //                   .catch((error) => {
    //                     reject("Upload failed");
    //                     console.error("Error:", error);
    //                   });
    //               });
    //             }
    //           }
    //         }
    //       });
  
    //       console.log(quill);
    //     });
    </script>
  </body>
</html>